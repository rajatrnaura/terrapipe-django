{% extends 'base.html' %}

{% block content %}
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  body {
    background-color: #f8f9fa;
  }

  #main-container {
    display: flex;
    position: absolute;
    top: 60px;
    left: 0;
    height: calc(100vh - 60px);
    width: 100vw;
  }

  #map {
    flex: 1 0 85%;
    height: 100%;
    z-index: 1;
  }

  .sidebar {
    flex: 0 0 15%;
    background: #fff;
    overflow-y: auto;
    padding: 10px;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .scope-entry {
    margin-bottom: 20px;
  }

  .scope-map {
    width: 100%;
    height: 160px;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .scope-code {
    margin-top: 6px;
    font-weight: bold;
    font-size: 14px;
    color: #333;
  }

  .top-search {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 8px;
    display: flex;
    gap: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  .search-input {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 14px;
    width: 200px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .suggestions-box {
    position: absolute;
    top: 65px;
    left: 50%;
    transform: translateX(-50%);
    width: 415px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    z-index: 2000;
    max-height: 200px;
    overflow-y: auto;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
  }

  .suggestions-box div {
    padding: 8px 10px;
    cursor: pointer;
  }

  .suggestions-box div:hover {
    background-color: #f0f0f0;
  }

  nav.navbar {
    z-index: 1100 !important;
  }

  .leaflet-top.leaflet-left {
    top: 70px !important;
    left: 10px !important;
    z-index: 1001;
  }
</style>

<div id="main-container">
  <div id="map"></div>
  <div class="sidebar">
    <h4>User Scopes</h4>
    <div id="scopes"></div>
  </div>
</div>

<div class="top-search">
  <input type="text" id="geoidSearch" class="search-input" placeholder="Search GeoID..." />
  <input type="text" id="addressSearch" class="search-input" placeholder="Enter address..." autocomplete="off" />
  <div id="address-suggestions" class="suggestions-box"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  const map = L.map('map').setView([30.7333, 76.7794], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
  }).addTo(map);

  $.get('/api/get_user_scope/', function(data) {
    const scopes = data.scopes;
    const scopesDiv = $('#scopes');

    scopes.forEach(function(scope) {
      $.get('/api/get_coordinates/' + scope + '/', function(coordData) {
        const rawCoords = coordData.geometry.coordinates[0];

        // Convert [lon, lat] to [lat, lon]
        const latlngs = rawCoords.map(c => [c[1], c[0]]);

        // Draw on main map
        const poly = L.polygon(latlngs, { color: "yellow", weight: 1 }).addTo(map);

        // Create mini-map thumbnail
        const thumbnailContainer = $('<div>').addClass('scope-map');
        const thumbnailMap = L.map(thumbnailContainer[0], {
          attributionControl: false,
          zoomControl: true,
          dragging: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          boxZoom: false,
          keyboard: false,
          tap: false,
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(thumbnailMap);
        L.polygon(latlngs, { color: "yellow", weight: 1 }).addTo(thumbnailMap);
        // thumbnailMap.fitBounds(L.polygon(latlngs).getBounds(), { padding: [5, 5] });
        const bounds = L.polygon(latlngs).getBounds();
        thumbnailMap.setView(bounds.getCenter(), 7); // You can adjust 12 to any value (e.g., 11 or 10) for broader view

        const container = $('<div>').addClass('scope-entry').click(() => {
          map.fitBounds(poly.getBounds(), { padding: [50, 50] });
        });

        container.append(thumbnailContainer);
        container.append($('<div>').addClass('scope-code').text(scope));
        scopesDiv.append(container);

        setTimeout(() => thumbnailMap.invalidateSize(), 200);
      });
    });
  });

  function searchLocation() {
    const geoid = $('#geoidSearch').val();
    const address = $('#addressSearch').val();

    if (geoid) {
      $.get('/api/get_coordinates/' + geoid + '/', function(data) {
        const rawCoords = data.geometry.coordinates[0];
        const latlngs = rawCoords.map(c => [c[1], c[0]]);
        const poly = L.polygon(latlngs, { color: "yellow", weight: 1 }).addTo(map);
        map.fitBounds(poly.getBounds(), { padding: [50, 50] });
      }).fail(() => alert('GeoID not found'));
    } else if (address) {
      $.get('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address), function(data) {
        if (data.length > 0) {
          const lat = data[0].lat;
          const lon = data[0].lon;
          map.setView([lat, lon], 13);
          L.marker([lat, lon]).addTo(map).bindPopup(address).openPopup();
        }
      });
    }
  }

  $('#addressSearch').on('input', function () {
    const query = $(this).val();
    if (query.length < 3) {
      $('#address-suggestions').hide();
      return;
    }

    $.get(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`, function (data) {
      const suggestionBox = $('#address-suggestions');
      suggestionBox.empty();

      if (data.length === 0) {
        suggestionBox.hide();
        return;
      }

      data.forEach(item => {
        const display = item.display_name;
        const lat = item.lat;
        const lon = item.lon;

        const div = $('<div>').text(display).click(() => {
          $('#addressSearch').val(display);
          suggestionBox.hide();
          map.setView([lat, lon], 13);
          L.marker([lat, lon]).addTo(map).bindPopup(display).openPopup();
        });

        suggestionBox.append(div);
      });

      suggestionBox.show();
    });
  });

  $('#geoidSearch, #addressSearch').on('keypress', function (e) {
    if (e.which === 13) {
      searchLocation();
    }
  });

  $(document).on('click', function (e) {
    if (!$(e.target).closest('#addressSearch, #address-suggestions').length) {
      $('#address-suggestions').hide();
    }
  });

  $(window).on('resize', function () {
    map.invalidateSize();
  });
</script>
{% endblock %}
